<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Response Rate by Client</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<input type="file" id="csvFile" accept=".csv" />
<canvas id="responseChart"></canvas>

<script>
const fileInput = document.getElementById('csvFile');
const ctx = document.getElementById('responseChart').getContext('2d');

let chart;
let csvData = [];

const Fields = {
  date:   ['SnapshotDate','Date'],
  client: ['ClientDBName','Client'],
  rate:   ['SubmissionRate','ResponseRate'],
};

function pick(row, keys){
  for(const k of keys){
    if (k in row) return row[k];
  }
  return undefined;
}

function parseDateMillis(s) {
  if (!s) return null;
  return new Date(s).getTime();
}

function render() {
  if (!csvData.length) return;

  const labels = [...new Set(csvData.map(r => pick(r, Fields.date)))]
    .sort((a,b)=>parseDateMillis(a)-parseDateMillis(b));

  const clients = [...new Set(csvData.map(r => pick(r, Fields.client)))];

  const datasets = clients.map((client,i)=>{
    const data = labels.map(date=>{
      const row = csvData.find(r =>
        pick(r, Fields.client)===client &&
        pick(r, Fields.date)===date
      );
      return row ? Number(pick(row, Fields.rate)) : null;
    });
    return {
      label: client,
      data,
      borderWidth: 2,
      tension: 0.25
    };
  });

  if (chart) chart.destroy();

  chart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true,
      scales:{
        y:{ beginAtZero:true }
      }
    }
  });
}

function handleParsedResults(results){
  csvData = (results.data || []).filter(r =>
    r && pick(r, Fields.date) && pick(r, Fields.client)
  );
  render();
}

function parseCsvText(csvText){
  Papa.parse(csvText,{
    header:true,
    skipEmptyLines:true,
    transformHeader:h=>String(h).trim(),
    transform:v=>(typeof v==='string'?v.trim():v),
    complete:handleParsedResults
  });
}

fileInput.addEventListener('change',e=>{
  const file = e.target.files?.[0];
  if(!file) return;
  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    transformHeader:h=>String(h).trim(),
    transform:v=>(typeof v==='string'?v.trim():v),
    complete:handleParsedResults
  });
});

/* ===============================
   SAFE DEFAULT CSV LOADING
   Works local + GitHub Pages
================================ */

const DEFAULT_CSV_URL =
  window.location.pathname.replace(/\/[^/]*$/, '/') +
  'many_modules_part_level.csv';

async function loadDefaultCsv(){
  try{
    const response = await fetch(DEFAULT_CSV_URL,{ cache:'no-store' });
    if(!response.ok){
      throw new Error(`Fetch failed: ${response.status}`);
    }
    const csvText = await response.text();
    parseCsvText(csvText);
  }catch(err){
    console.error('Auto-load CSV failed:',err);
  }
}

window.addEventListener('DOMContentLoaded',()=>{
  loadDefaultCsv();
});
</script>

</body>
</html>
